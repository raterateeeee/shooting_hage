<!doctype html>
<!-- shooting_hage : stage3 fx full / VERSION v1.7.0 "LaserFix + StartSafe" -->
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>👩 vs 🧑‍🦲 — STG（3面・星背景・ボス中ザコ停止・レーザー） v1.7.0</title>
<style>
:root{--ui:rgba(0,0,0,.55);--txt:#fff}
html,body{margin:0;height:100%;background:#0b1020;color:var(--txt);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji","Noto Emoji",sans-serif;
  touch-action:none;-webkit-user-select:none;user-select:none}
#wrap{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
#hud{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.5rem .75rem;background:var(--ui);backdrop-filter:blur(6px);z-index:10}
#hud .g{display:flex;align-items:center;gap:.6rem}
#score{font-weight:700;letter-spacing:.5px}
#hearts{font-size:1.1rem}
#btns button{appearance:none;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;padding:.35rem .6rem;border-radius:.75rem;font-weight:600}
canvas{width:100%;height:100%;display:block;background:#000}
.ov{position:absolute;inset:0;display:grid;place-items:center;z-index:20}
.panel{background:var(--ui);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:1rem;padding:1rem 1.2rem;width:min(92vw,560px);box-shadow:0 10px 30px rgba(0,0,0,.4)}
.panel h1{margin:.2rem 0 .5rem;font-size:1.1rem}
.panel p{margin:.25rem 0;opacity:.9}
.panel .cta{margin-top:.75rem;text-align:center}
.panel .cta button{font-size:1.05rem;padding:.6rem 1rem;border-radius:.9rem;border:none;color:#061018;background:linear-gradient(180deg,#7fe0ff,#46b3ff 60%,#2c89ff);font-weight:800;letter-spacing:.4px}
.small{font-size:.85rem;opacity:.8}
#bossbar{position:absolute;top:48px;left:50%;transform:translateX(-50%);z-index:12;width:min(92vw,560px);height:18px;border:1px solid rgba(255,120,120,.7);background:rgba(120,0,0,.35);border-radius:10px;overflow:hidden;display:none}
#bossbar .fill{height:100%;width:100%;background:linear-gradient(90deg,#ff3b3b,#ff7a7a);box-shadow:0 0 14px rgba(255,60,60,.7) inset}
#bossbar .label{position:absolute;inset:0;display:grid;place-items:center;font-size:12px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.8)}
#toast{position:absolute;top:85px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.25);padding:.35rem .7rem;border-radius:.6rem;font-weight:700;display:none;z-index:12}
#buffs{position:absolute;top:48px;right:10px;z-index:12;display:flex;gap:.35rem;align-items:center}
#buffs .chip{display:inline-flex;align-items:center;gap:.25rem;background:rgba(0,0,0,.38);border:1px solid rgba(255,255,255,.2);border-radius:.6rem;padding:.15rem .4rem;font-size:.85rem}
.flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:19}
#ver{position:absolute;left:8px;bottom:6px;z-index:30;font:600 11px/1 system-ui;color:#cfe0ff;opacity:.8;background:rgba(0,0,0,.35);padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15)}
</style>
</head>
<body>
<div id="wrap">
  <div id="hud">
    <div class="g"><span>👩</span><span id="score">SCORE 0</span></div>
    <div class="g"><span id="hearts">❤️❤️❤️❤️</span></div>
    <div class="g" id="btns">
      <button id="pauseBtn" aria-label="一時停止/再開">⏸︎</button>
      <button id="resetBtn" aria-label="リセット">↺</button>
    </div>
  </div>

  <div id="bossbar"><div class="fill"></div><div class="label">BOSS HP</div></div>
  <div id="toast">STAGE 2</div>
  <div id="buffs"></div>
  <div class="flash" id="flash"></div>
  <canvas id="cv"></canvas>

  <div id="startOv" class="ov">
    <div class="panel">
      <h1>👩 vs 🧑‍🦲 縦スクSTG（3面・演出多め・星背景）</h1>
      <p>操作：相対ドラッグで左右。攻撃は<b>👹</b>自動連射。</p>
      <p>アイテム：<b>🌺</b>=火力UP、<b>🦆</b>=無敵（青グロー）、<b>❤️</b>=HP+1。</p>
      <p>各面<b>45秒</b>で<b>👴</b>出現。撃破で次面＆HP満タン。3面クリアでCOMPLETE。</p>
      <div class="cta"><button id="startBtn">タップで開始（画面タップでもOK）</button></div>
    </div>
  </div>

  <div id="overOv" class="ov" style="display:none">
    <div class="panel">
      <h1>GAME OVER</h1>
      <p id="finalScore">SCORE 0</p>
      <p id="bestScore" class="small">BEST 0</p>
      <div class="cta"><button id="retryBtn">もう一度</button></div>
    </div>
  </div>

  <div id="clearOv" class="ov" style="display:none">
    <div class="panel">
      <h1>GAME COMPLETE ✨</h1>
      <p id="clearScore">SCORE 0</p>
      <div class="cta"><button id="againBtn">もう一回</button></div>
    </div>
  </div>

  <div id="ver">v1.7.0</div>
</div>

<script>
(()=>{
/* ========= 1) まずは補助関数を最上部に（rand順序バグ対策） ========= */
const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
const rand=(a,b)=>a+Math.random()*(b-a);
const randi=(a,b)=>(a+Math.floor(Math.random()*((b-a)+1)));
const circle=(ctx,x,y,r,mode)=>{ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);mode==='fill'?ctx.fill():ctx.stroke();}
const hit=(a,b)=>{const dx=a.x-b.x,dy=a.y-b.y;const rr=(a.r+b.r);return dx*dx+dy*dy<=rr*rr;};
function drawEmoji(ctx,ch,x,y,size){ctx.font=`${size}px "Noto Color Emoji","Apple Color Emoji","Segoe UI Emoji","Noto Emoji",sans-serif`;ctx.fillText(ch,x,y+2);}

/* ========= 2) 定数 ========= */
const AUDIO_BASE = "https://github.com/raterateeeee/shooting_hage/raw/refs/heads/main/sounds/";
const MAX_HP = 4;
const BOSS_TIME = 45;
const HIT_IFR = 1.5;
const POWER_MS = 5000;
const SHIELD_MS = 5000;
const HEART_CD = [20,28];
const ENEMY_RATE = 1.0;

/* ========= 3) 要素参照 ========= */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const scoreEl = document.getElementById('score');
const heartsEl = document.getElementById('hearts');
const startOv = document.getElementById('startOv');
const overOv = document.getElementById('overOv');
const clearOv = document.getElementById('clearOv');
const finalScoreEl = document.getElementById('finalScore');
const bestScoreEl = document.getElementById('bestScore');
const clearScoreEl = document.getElementById('clearScore');
const startBtn = document.getElementById('startBtn');
const retryBtn = document.getElementById('retryBtn');
const againBtn = document.getElementById('againBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resetBtn = document.getElementById('resetBtn');
const bossBar = document.getElementById('bossbar');
const bossFill = bossBar.querySelector('.fill');
const bossLabel = bossBar.querySelector('.label');
const toast = document.getElementById('toast');
const buffsEl = document.getElementById('buffs');
const flashEl = document.getElementById('flash');

/* ========= 4) オーディオ ========= */
function makeAudio(name, loop=false, vol=1){ const a=new Audio(AUDIO_BASE+name); a.loop=loop; a.volume=vol; return a; }
const SND = {
  bgm: makeAudio("Shooting_Zone.mp3", true, 0.5),
  bossDown: makeAudio("bosu_gekiha.mp3", false, 0.9),
  enemyDown: makeAudio("teki_dameji.mp3", false, 0.7),
  hit: makeAudio("jibun_dameji.mp3", false, 0.8),
  heal: makeAudio("kaihuku.mp3", false, 0.9),
  ok: makeAudio("kettei.mp3", false, 0.8),
};

/* ========= 5) 状態 ========= */
let W=0,H=0,t=0,last=0,raf;
const STATE={title:0,playing:1,paused:2,over:3,clear:4};
let state=STATE.title;
const EMOJI = { player:'👩', enemy:['👴','👩‍🦲','👨‍🦲'], pBullet:'👹', eBullet:'✨', power:'🌺', shield:'🦆', heal:'❤️', boss:'👴' };
const world={speed:120,difficulty:1,score:0,best:Number(localStorage.getItem('stg_best')||0)};
const player={x:0,y:0,r:22,hp:MAX_HP,ifr:0,fireCd:0,fireBase:0.22,powerMs:0,shieldMs:0};
const enemies=[], bullets=[], ebullets=[], particles=[], items=[];
let boss=null, stage=1, timeSinceStage=0, stageTransition=0, slowMo=0, shake=0;

/* ========= 6) 画面サイズ ========= */
function resize(){ const cw=innerWidth,ch=innerHeight;
  cv.style.width=cw+'px';cv.style.height=ch+'px';
  cv.width=Math.floor(cw*DPR);cv.height=Math.floor(ch*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0); ctx.textAlign='center';ctx.textBaseline='middle'; W=cw;H=ch; }
addEventListener('resize', resize, {passive:true}); resize();

/* ========= 7) 背景（星のみ） ========= */
const starsFar = Array.from({length:70},()=>({x:Math.random(),y:Math.random(),s:rand(0.4,1.0)}));
const starsNear= Array.from({length:55},()=>({x:Math.random(),y:Math.random(),s:rand(1.0,1.8)}));
function drawBg(dt){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha=0.7; ctx.fillStyle='#0e2340';
  for(const s of starsFar){ s.y+=(world.speed*0.12*dt*s.s)/H; if(s.y>1) s.y-=1; circle(ctx,s.x*W,s.y*H,1.0*s.s,'fill'); }
  ctx.fillStyle='#cfe0ff';
  for(const s of starsNear){ s.y+=(world.speed*0.28*dt*s.s)/H; if(s.y>1) s.y-=1; const tw=0.65+0.35*Math.sin((t*6)+(s.x*17));
    ctx.globalAlpha=0.75*tw; circle(ctx,s.x*W,s.y*H,1.4*s.s,'fill'); }
  ctx.globalAlpha=1;
}

/* ========= 8) UI更新 ========= */
function updateHearts(){ heartsEl.textContent='❤️'.repeat(player.hp)+'🖤'.repeat(Math.max(0,MAX_HP-player.hp)); }
function updateScore(){ scoreEl.textContent='SCORE '+world.score; }
function updateBuffs(){ buffsEl.innerHTML='';
  if(player.powerMs>0){const c=document.createElement('div');c.className='chip';c.textContent='🌺 '+Math.ceil(player.powerMs/1000)+'s';buffsEl.appendChild(c)}
  if(player.shieldMs>0){const c=document.createElement('div');c.className='chip';c.textContent='🦆 '+Math.ceil(player.shieldMs/1000)+'s';buffsEl.appendChild(c)}
}
function showToast(msg,ms=1400){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); }

/* ========= 9) 入力（相対ドラッグ） ========= */
let dragging=false,lastTouchX=null;
function onPointer(e){
  const p=e.touches?e.touches[0]:e;
  if(state===STATE.playing){
    if(lastTouchX==null) lastTouchX=p.clientX;
    const dx=p.clientX-lastTouchX;
    player.x += dx*0.9;
    player.x = Math.max(24, Math.min(W-24, player.x));
    lastTouchX=p.clientX;
  }
}
cv.addEventListener('pointerdown', e=>{dragging=true;lastTouchX=null;onPointer(e)});
cv.addEventListener('pointermove', e=>{if(dragging) onPointer(e)});
addEventListener('pointerup', ()=>{dragging=false;lastTouchX=null});

/* ========= 10) リセット ========= */
let spawnTimer=0,itemTimer=5.25,shieldTimer=12,heartTimer=24;
function reset(){
  world.score=0;world.difficulty=1;world.speed=120;
  player.x=W/2;player.y=H*0.82;player.hp=MAX_HP;player.ifr=0;player.fireCd=0;player.powerMs=0;player.shieldMs=0;
  enemies.length=0;bullets.length=0;ebullets.length=0;particles.length=0;items.length=0;boss=null;
  bossBar.style.display='none';stage=1;timeSinceStage=0;stageTransition=0;slowMo=0;shake=0;
  updateHearts();updateScore();updateBuffs();t=0;last=performance.now();
  spawnTimer=0; itemTimer=5.25; shieldTimer=12; heartTimer=rand(HEART_CD[0],HEART_CD[1]);
}

/* ========= 11) スポーン ========= */
function spawnEnemy(){ enemies.push({x:rand(30,W-30),y:-40,r:24,vx:rand(-20,20),vy:rand(70,110)+world.difficulty*8,hp:2+Math.floor(world.difficulty*0.3),fireCd:rand(0.5,1.3),emoji:EMOJI.enemy[randi(0,2)]}); }
function spawnPower(){ items.push({x:rand(30,W-30),y:-30,r:18,vy:rand(60,90),kind:'power'}) }
function spawnShield(){ items.push({x:rand(30,W-30),y:-30,r:20,vy:rand(60,90),kind:'shield'}) }
function spawnHeart(){ items.push({x:rand(30,W-30),y:-30,r:18,vy:rand(60,90),kind:'heal'}) }
function fire(x,y,vx,vy,from,extra={}){ bullets.push({x,y,vx,vy,r:from==='p'?18:16,from,...extra}); }
function fireEnemy(x,y,vx,vy){ ebullets.push({x,y,vx,vy,r:16}); }
function boom(x,y,n=10){ for(let i=0;i<n;i++) particles.push({x,y,vx:rand(-80,80),vy:rand(-120,0),t:0,life:rand(0.3,0.6)}); }

/* ========= 12) ボス ========= */
function bossParamsFor(st){
  if(st===1) return {hp:174,size:128,vx:80,vy:90,aimCD:0.7,burstCD:2.6,burstN:12,aimSp:230,burstSp:180, laserW:80,  laserHold:1.1,  laserCD:7.0};
  if(st===2) return {hp:254,size:144,vx:110,vy:110,aimCD:0.55,burstCD:2.2,burstN:16,aimSp:260,burstSp:210, laserW:96,  laserHold:1.2,  laserCD:6.5};
  return           {hp:320,size:152,vx:120,vy:120,aimCD:0.5, burstCD:2.0,burstN:18,aimSp:280,burstSp:230, laserW:112, laserHold:1.25, laserCD:6.0};
}
function spawnBoss(){
  const p=bossParamsFor(stage);
  boss={x:W/2,y:-p.size*1.2,r:p.size*0.62,hp:p.hp,maxHp:p.hp,vx:p.vx,vy:p.vy,
        aimCD:p.aimCD,burstCD:p.burstCD,burstN:p.burstN,aimSp:p.aimSp,burstSp:p.burstSp,
        fireT:0,burstT:0,size:p.size,
        // レーザー関連
        laserCD:p.laserCD, laserTimer:rand(2.5,4.0),
        charging:false, chargeRemain:0,
        laserActive:false, laserRemain:0,
        laserW:p.laserW, laserHold:p.laserHold, laserX:0 };
  bossBar.style.display='block'; updateBossBar();
}
function updateBossBar(){
  if(!boss){bossBar.style.display='none';return;}
  const ratio=Math.max(0,boss.hp/boss.maxHp);
  bossFill.style.width=(ratio*100)+'%';
  bossLabel.textContent=`BOSS HP ${Math.ceil(boss.hp)}/${boss.maxHp} (STAGE ${stage})`;
}

/* ========= 13) メインループ ========= */
function step(ts){
  raf=requestAnimationFrame(step);
  const now=ts||performance.now();
  let dt=Math.min(0.033,(now-last)/1000); last=now; t+=dt;
  if(state!==STATE.playing) return;

  if(slowMo>0){ slowMo=Math.max(0,slowMo-dt); dt*=0.35; }
  if(stageTransition>0){ stageTransition=Math.max(0,stageTransition-dt); }
  else { timeSinceStage += dt; }

  world.difficulty += dt*0.2;
  world.speed = 120 + world.difficulty*20;

  if(shake>0){ shake=Math.max(0,shake-dt); ctx.save(); ctx.translate(rand(-8,8)*shake*3,rand(-8,8)*shake*3); }

  // 背景
  drawBg(dt);

  // 出現（演出中はゲート）
  if(!boss && stageTransition<=0 && timeSinceStage>BOSS_TIME) spawnBoss();

  // アイテム（ボス中は新規出現停止）
  itemTimer-=dt; shieldTimer-=dt; heartTimer-=dt;
  if(itemTimer<=0 && !boss){ spawnPower(); itemTimer=rand(5.25,9.75); }
  if(shieldTimer<=0 && !boss){ spawnShield(); shieldTimer=rand(12,18); }
  if(heartTimer<=0 && !boss){ spawnHeart(); heartTimer=rand(HEART_CD[0], HEART_CD[1]); }

  // プレイヤー状態
  player.fireCd-=dt;
  if(player.powerMs>0) player.powerMs=Math.max(0,player.powerMs-dt*1000);
  if(player.shieldMs>0) player.shieldMs=Math.max(0,player.shieldMs-dt*1000);
  if(player.ifr>0) player.ifr=Math.max(0,player.ifr-dt);
  updateBuffs();

  // 自動射撃
  if(player.fireCd<=0){
    if(player.powerMs>0){
      fire(player.x-14,player.y-28,0,-420,'p',{glow:true,dmg:2});
      fire(player.x+14,player.y-28,0,-420,'p',{glow:true,dmg:2});
      player.fireCd=Math.max(0.08,(player.fireBase-world.difficulty*0.01)*0.7);
    }else{
      fire(player.x,player.y-28,0,-360,'p',{glow:false,dmg:1});
      player.fireCd=Math.max(0.12,player.fireBase-world.difficulty*0.01);
    }
  }

  // 雑魚：ボス不在時のみ新規生成（移動は常に）
  spawnTimer-=dt;
  let baseInterval = Math.max(0.35, (1.1 - world.difficulty*0.08)/ENEMY_RATE);
  if(!boss && spawnTimer<=0){ spawnEnemy(); spawnTimer=baseInterval; }
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.x+=e.vx*dt; e.y+=e.vy*dt; if(e.x<22||e.x>W-22) e.vx*=-1;
    e.fireCd-=dt;
    if(e.fireCd<=0){ fireEnemy(e.x,e.y+16,0,rand(140,220)+world.difficulty*12); e.fireCd=rand(0.9,1.6)-world.difficulty*0.03; }
    if(e.y>H+60){ enemies.splice(i,1); }
  }

  // ボスAI + レーザー
  if(boss){
    const ty=H*0.22;
    if(boss.y<ty){ boss.y+=boss.vy*dt; if(boss.y>ty) boss.y=ty; }
    boss.x+=boss.vx*dt; if(boss.x<40||boss.x>W-40) boss.vx*=-1;

    // 通常弾
    boss.fireT-=dt; boss.burstT-=dt;
    if(boss.fireT<=0){
      const dx=player.x-boss.x, dy=player.y-boss.y, len=Math.hypot(dx,dy)||1;
      fireEnemy(boss.x,boss.y+22,dx/len*boss.aimSp,dy/len*boss.aimSp);
      boss.fireT=boss.aimCD;
    }
    if(boss.burstT<=0){
      const n=boss.burstN, sp=boss.burstSp;
      const offset=(t*2)%(Math.PI*2)*(stage===3?0.6:stage===2?0.5:0.35);
      for(let k=0;k<n;k++){ const a=(Math.PI*2)*(k/n)+offset; fireEnemy(boss.x,boss.y+20,Math.cos(a)*sp,Math.sin(a)*sp); }
      boss.burstT=boss.burstCD;
    }

    // レーザー管理（2秒チャージ→縦ビーム）
    if(!boss.charging && !boss.laserActive){
      boss.laserTimer -= dt;
      if(boss.laserTimer<=0){ boss.charging=true; boss.chargeRemain=2.0; }
    }else if(boss.charging){
      boss.chargeRemain -= dt;
      const orbX=boss.x, orbY=boss.y-boss.r-24, prog=Math.max(0,1-boss.chargeRemain/2.0);
      ctx.save();
      ctx.shadowColor='rgba(255,230,120,1)'; ctx.shadowBlur=28;
      ctx.fillStyle='rgba(255,230,120,.85)'; circle(ctx,orbX,orbY,10+prog*16,'fill');
      ctx.lineWidth=2; ctx.strokeStyle='rgba(255,250,200,.9)'; circle(ctx,orbX,orbY,18+prog*14,'stroke');
      ctx.restore();
      if(boss.chargeRemain<=0){
        boss.charging=false; boss.laserActive=true; boss.laserRemain=boss.laserHold;
        boss.laserX=boss.x; boss.laserTimer=boss.laserCD;
        flashEl.style.transition='none'; flashEl.style.opacity='0.35'; setTimeout(()=>{flashEl.style.transition='opacity .25s'; flashEl.style.opacity='0';},20);
      }
    }else if(boss.laserActive){
      boss.laserRemain -= dt;
      const w=boss.laserW;
      const g=ctx.createLinearGradient(boss.laserX,boss.y,boss.laserX,H);
      g.addColorStop(0,'rgba(255,240,120,0.95)'); g.addColorStop(0.2,'rgba(255,210,90,0.8)'); g.addColorStop(1,'rgba(255,120,60,0.35)');
      ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.fillStyle=g; ctx.fillRect(boss.laserX-w/2,boss.y,w,H-boss.y); ctx.restore();
      const inBeam = Math.abs(player.x-boss.laserX) <= (w*0.5-6) && player.y>boss.y;
      if(inBeam){ const inv=(player.shieldMs>0||player.ifr>0);
        if(!inv){ player.hp=Math.max(0,player.hp-1); updateHearts(); player.ifr=HIT_IFR; shake=Math.max(shake,0.45); try{SND.hit.currentTime=0;SND.hit.play()}catch{}; if(player.hp<=0){ return gameOver(); } }
      }
      if(boss.laserRemain<=0){ boss.laserActive=false; }
    }
  }

  // 弾移動
  for(let i=ebullets.length-1;i>=0;i--){ const b=ebullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; if(b.y>H+80||b.y<-80||b.x<-80||b.x>W+80) ebullets.splice(i,1); }
  for(let i=bullets.length-1;i>=0;i--){ const b=bullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; if(b.y<-80||b.y>H+80||b.x<-80||b.x>W+80) bullets.splice(i,1); }

  // 衝突：プレイヤー弾 vs 雑魚
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j]; if(b.from!=='p') continue;
      if(hit({x:e.x,y:e.y,r:e.r*0.9},b)){
        bullets.splice(j,1); e.hp-=(b.dmg||1);
        if(e.hp<=0){ enemies.splice(i,1); boom(e.x,e.y,10); world.score+=10; updateScore(); try{SND.enemyDown.currentTime=0;SND.enemyDown.play()}catch{} }
        break;
      }
    }
  }

  // 衝突：プレイヤー弾 vs ボス
  if(boss){
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j]; if(b.from!=='p') continue;
      if(hit({x:boss.x,y:boss.y,r:boss.r*1.05},b)){
        bullets.splice(j,1); boss.hp-=(b.dmg||1); updateBossBar();
        if(boss.hp<=0){
          for(let n=0;n<120;n++) particles.push({x:boss.x,y:boss.y,vx:rand(-220,220),vy:rand(-260,60),t:0,life:rand(0.35,0.8)});
          flashEl.style.transition='none'; flashEl.style.opacity='0.9'; setTimeout(()=>{flashEl.style.transition='opacity .35s'; flashEl.style.opacity='0';},20);
          slowMo=1.4; shake=0.6; try{SND.bossDown.currentTime=0;SND.bossDown.play()}catch{};
          boss=null; bossBar.style.display='none';
          timeSinceStage=0; stageTransition=1.4;
          setTimeout(()=>{
            if(stage<3){
              stage++; timeSinceStage=0;
              enemies.length=0; ebullets.length=0; items.length=0; // 画面整理
              player.hp=MAX_HP; updateHearts(); showToast('STAGE '+stage,1600);
              stageTransition=0;
            }else{
              state=STATE.clear; cancelAnimationFrame(raf); clearScoreEl.textContent='SCORE '+world.score; clearOv.style.display='';
            }
          },1200);
        }
      }
    }
  }

  // 敵弾 → プレイヤー
  const invul=(player.shieldMs>0 || player.ifr>0);
  if(!invul){
    for(let i=ebullets.length-1;i>=0;i--){
      const b=ebullets[i];
      if(hit({x:player.x,y:player.y,r:player.r*0.85},b)){
        ebullets.splice(i,1); player.hp=Math.max(0,player.hp-1); updateHearts(); player.ifr=HIT_IFR;
        shake=Math.max(shake,0.35); try{SND.hit.currentTime=0;SND.hit.play()}catch{}
        if(player.hp<=0){ return gameOver(); }
      }
    }
  }else{
    for(let i=ebullets.length-1;i>=0;i--){ const b=ebullets[i]; if(hit({x:player.x,y:player.y,r:player.r*0.72},b)) ebullets.splice(i,1); }
  }

  // アイテム（ボス中は新規出現しないが残りは拾える）
  for(let i=items.length-1;i>=0;i--){
    const it=items[i]; it.y+=80*dt;
    if(hit({x:player.x,y:player.y,r:player.r},{x:it.x,y:it.y,r:it.r})){
      items.splice(i,1);
      if(it.kind==='power'){ player.powerMs=POWER_MS; }
      else if(it.kind==='shield'){ player.shieldMs=SHIELD_MS; player.ifr=0; }
      else if(it.kind==='heal'){ player.hp=Math.min(MAX_HP,player.hp+1); updateHearts(); try{SND.heal.currentTime=0;SND.heal.play()}catch{} }
    }else if(it.y>H+50){ items.splice(i,1); }
  }

  // 描画（残り粒子）
  for(const e of enemies){ const tw=(Math.sin(t*12)+1)*0.5; ctx.save(); if(e.fireCd<0.2){ctx.globalAlpha=0.6+0.4*tw;} drawEmoji(ctx,e.emoji,e.x,e.y,40); ctx.restore(); }
  if(boss){ ctx.save(); ctx.shadowColor='rgba(255,60,60,.95)'; ctx.shadowBlur=25; drawEmoji(ctx,EMOJI.boss,boss.x,boss.y,boss.size); ctx.restore(); }
  for(const b of bullets){ const glowOn=(b.glow||player.powerMs>0)&&b.from==='p'; if(glowOn){ctx.save();ctx.shadowColor='yellow';ctx.shadowBlur=18;} drawEmoji(ctx,EMOJI.pBullet,b.x,b.y,28); if(glowOn)ctx.restore(); }
  for(const b of ebullets){ drawEmoji(ctx,EMOJI.eBullet,b.x,b.y,24); }
  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.t+=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=120*dt; const a=1-p.t/p.life; if(a<=0){particles.splice(i,1);continue;} ctx.globalAlpha=Math.max(0,a); ctx.fillStyle='#7fe0ff'; circle(ctx,p.x,p.y,2,'fill'); ctx.globalAlpha=1; }

  if(shake>0) ctx.restore();
}

/* ========= 14) ループ・開始・終了 ========= */
function loop(){ last=performance.now(); raf=requestAnimationFrame(step); }
function start(){
  reset(); state=STATE.playing; startOv.style.display='none'; overOv.style.display='none'; clearOv.style.display='none';
  try{ SND.ok.currentTime=0; SND.ok.play().catch(()=>{}); SND.bgm.currentTime=0; SND.bgm.play().catch(()=>{}); }catch{}
  loop();
}
function gameOver(){
  state=STATE.over; cancelAnimationFrame(raf);
  world.best=Math.max(world.best,world.score); localStorage.setItem('stg_best',world.best);
  finalScoreEl.textContent='SCORE '+world.score; bestScoreEl.textContent='BEST '+world.best;
  overOv.style.display='';
}

/* ========= 15) UI（開始はボタンでもオーバーレイどこでもOK） ========= */
function bindStartOnce(el){ if(!el) return; const go=(e)=>{e.preventDefault(); start();}; el.addEventListener('click', go, {once:true}); el.addEventListener('touchend', go, {once:true, passive:false}); }
bindStartOnce(startBtn); bindStartOnce(startOv);
retryBtn?.addEventListener('click', (e)=>{e.preventDefault(); start();});
againBtn?.addEventListener('click', (e)=>{e.preventDefault(); start();});
resetBtn.addEventListener('click', (e)=>{e.preventDefault(); if(state===STATE.playing||state===STATE.paused){ start(); }});
pauseBtn.addEventListener('click', (e)=>{e.preventDefault(); if(state===STATE.playing){ state=STATE.paused; pauseBtn.textContent='▶'; SND.bgm.pause(); } else if(state===STATE.paused){ state=STATE.playing; last=performance.now(); pauseBtn.textContent='⏸︎'; SND.bgm.play().catch(()=>{}); }});

/* タイトル画面のアイドル描画 */
function idle(){ if(state!==STATE.title) return; requestAnimationFrame(idle); const dt=1/60; drawBg(dt); ctx.globalAlpha=.85; drawEmoji(ctx,EMOJI.player,innerWidth/2,innerHeight*0.78,42); ctx.globalAlpha=1; }
idle();

})();
</script>
</body>
</html>
